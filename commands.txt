## Gateway
curl localhost:8080/actuator/gateway/routes -s | jq '.[] | {"\(.route_id)": "\(.route_definition.predicates[0].args._genkey_0)"}'

docker-compose logs -f --tail=0 gateway

curl localhost:8080/product-composite/2

curl -H "accept:application/json" localhost:8080/eureka/api/apps -s | jq -r .applications.application[].instance[].instanceId

http://localhost:8080/eureka/web

curl http://localhost:8080/headerrouting -H "Host: i.feel.lucky:8080"
curl http://localhost:8080/headerrouting -H "Host: im.a.teapot:8080"
curl http://localhost:8080/headerrouting

sudo bash -c "echo '127.0.0.1 i.feel.lucky im.a.teapot' >> /etc/hosts"

curl http://i.feel.lucky:8080/headerrouting
curl http://im.a.teapot:8080/headerrouting

docker-compose down

## security

(option) keytool -genkeypair -alias localhost -keyalg RSA -keysize 2048 -storetype PKCS12 -keystore edge-test.p12 -validity 3650
enter: password
enter: testtest

docker-compose up -d --scale gateway=0
docker-compose up -d --scale gateway=1

ACCESS_TOKEN=$(curl k https://writer:secret@$HOST:$PORT/oauth/token -d grant_type=password -d username=magnus -d password=password -s | jq .access_token -r)

Magnus Larsson. Hands-On Microservices with Spring Boot and Spring Cloud (Kindle Locations 5879-5880).

./gradlew build && docker-compose build
./test-all.sh start

curl -k https://writer:secret@localhost:8443/oauth/token -d grant_type=password -d username=magnus -d password=password -s | jq .
curl -k https://reader:secret@localhost:8443/oauth/token -d grant_type=password -d username=magnus -d password=password -s | jq .

ACCESS_TOKEN=

https://localhost:8443/oauth/authorize?response_type=token&client_id=reader&redirect_uri=http://my.redirect.uri&scope=product:read&state=48532
https://localhost:8443/oauth/authorize?response_type=token&client_id=writer&redirect_uri=http://my.redirect.uri&scope=product:read+product:write&state=95372
enter: magnus/password

http://my.redirect.uri/#access_token=eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJtYWdudXMiLCJleHAiOjIxNzcyOTI4NjcsImF1dGhvcml0aWVzIjpbIlJPTEVfVVNFUiJdLCJqdGkiOiIxMjkwNTMwOC01MmJiLTQzYzAtYWMzMS03OTZhMzA4M2YyYWYiLCJjbGllbnRfaWQiOiJyZWFkZXIiLCJzY29wZSI6WyJwcm9kdWN0OnJlYWQiXX0.TbFzyzjCeo_-TZyaBJejJI3GCGbdMwvzD-1Mtgj91asIU4sO4xUVpIxkrPWxMaWzURBYeVCVCy4_R3KMUwc1d95jUQDA6dsdzWYb8ngnoPxcPT2pWfyi_WCwbjPbt7lSEL-li9Lr9XPk4-YG7cxZX07rxQWngUHEEOtJTktJPO0RE_df2UL7Sbel2PV_arQcC4EWJZwbYvvYBwCFVG_ZiTPYC0vlEnJk02OMR_5KMRtdWHYDRogHAmi8oujUbeoJTjyXmm6-dTX5i2-5owUzBr20rzH5wqDeTyphSWwRvUSqp7-Y1gHBC5fnDTJc8C87v5Y6ECRUIoUXS80TtbrVQA&token_type=bearer&state=48532&expires_in=599999999&jti=12905308-52bb-43c0-ac31-796a3083f2af
http://my.redirect.uri/#access_token=eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJtYWdudXMiLCJleHAiOjIxNzcyOTMxMDMsImF1dGhvcml0aWVzIjpbIlJPTEVfVVNFUiJdLCJqdGkiOiJmYWQ4OTRjNi1hMWEwLTQ4YWItODYwNi1kMzZmNDVlMzdmNGIiLCJjbGllbnRfaWQiOiJ3cml0ZXIiLCJzY29wZSI6WyJwcm9kdWN0OnJlYWQiLCJwcm9kdWN0OndyaXRlIl19.K5D0YPpsJ8VirinTs4ljgY5TSygKN3muCpUlTQx9_DKx0muhKOCkAx_Ut0ShSw-9NZd9_vKUOYO5GHVc63LO8zeOCXc5QhaYTz1AKRQvVgQ7UlJdbBgxREoDx3Kz7-cyRPoyF2tqsFiYBkyWxfC959wrZeVZJ5WT3GDRIf2cEWSZ3R0AIhmDvq3VwbXxTgR-Un3iTwtfRFdcxcn9s_dThDfbqCrcIWlyoydDv_Vd1OAaQc5hfVmzDvpgr_EUQYF9o54tJ3TWmy9YxETeYNy0K7xd8WOO_lqHKQg-vKGLKQPAQlnRgMdnRMAMCxaV26YCPkE8jCDh9q57491gCCOvCQ&token_type=bearer&state=95372&expires_in=599999999&jti=fad894c6-a1a0-48ab-8606-d36f45e37f4b

https://localhost:8443/oauth/authorize?response_type=code&client_id=reader&redirect_uri=http://my.redirect.uri&scope=product:read&state=35725

http://my.redirect.uri/?code=LKidCV&state=35725
CODE=LKidCV

curl -k https://reader:secret@localhost:8443/oauth/token \
-d grant_type=authorization_code \
-d client_id=reader \
-d redirect_uri=http://my.redirect.uri \
-d code=$CODE -s | jq .

[reader]
ACCESS_TOKEN=eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJtYWdudXMiLCJleHAiOjIxNzcyOTM1NTYsImF1dGhvcml0aWVzIjpbIlJPTEVfVVNFUiJdLCJqdGkiOiI2ZTA2NGNkMS1lYmVhLTRhYTYtOWE5OC0wZGQxODA1ZjU4NWEiLCJjbGllbnRfaWQiOiJyZWFkZXIiLCJzY29wZSI6WyJwcm9kdWN0OnJlYWQiXX0.OyB1ZmTcKp5WK1YLIjbbDipf4lFkuww3mdDbs5hVvhuOSIbv_ALQ1gD6ehSvlwNh6JZQ5pJubqTDhMR-OTj24_kpVnFEJGkOabPQfLowWdK0ZeT55Ar-_JdF8s9TNhL2SVH8QE1HVD7DqHcQIz9z8Obn6omMiTSX8cJRMrtK6RNKUOgMPvRBVZ_2GthbJCgMpm_tgfzM2ki9iKWGolWCh8VNEKaU_yzkgu7kc5B_GgJCLQUW5QqKO61cma3IVDdcrB24B2KYxdeRyl1s7LhiRrTSawVP3HWQVYaL_xJ2F1hUTmPr5Rwq_AcMAWJUsu7mQRrDGRBQDCLPcS9mIArUlw

https://localhost:8443/oauth/authorize?response_type=code&client_id=writer&redirect_uri=http://my.redirect.uri&scope=product:read+product:write&state=72489

ACCESS_TOKEN=an-invalid-token
curl https://localhost:8443/product-composite/2 -k -H "Authorization: Bearer $ACCESS_TOKEN" -i
[reader]
ACCESS_TOKEN=eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJtYWdudXMiLCJleHAiOjIxNzcyOTM1NTYsImF1dGhvcml0aWVzIjpbIlJPTEVfVVNFUiJdLCJqdGkiOiI2ZTA2NGNkMS1lYmVhLTRhYTYtOWE5OC0wZGQxODA1ZjU4NWEiLCJjbGllbnRfaWQiOiJyZWFkZXIiLCJzY29wZSI6WyJwcm9kdWN0OnJlYWQiXX0.OyB1ZmTcKp5WK1YLIjbbDipf4lFkuww3mdDbs5hVvhuOSIbv_ALQ1gD6ehSvlwNh6JZQ5pJubqTDhMR-OTj24_kpVnFEJGkOabPQfLowWdK0ZeT55Ar-_JdF8s9TNhL2SVH8QE1HVD7DqHcQIz9z8Obn6omMiTSX8cJRMrtK6RNKUOgMPvRBVZ_2GthbJCgMpm_tgfzM2ki9iKWGolWCh8VNEKaU_yzkgu7kc5B_GgJCLQUW5QqKO61cma3IVDdcrB24B2KYxdeRyl1s7LhiRrTSawVP3HWQVYaL_xJ2F1hUTmPr5Rwq_AcMAWJUsu7mQRrDGRBQDCLPcS9mIArUlw
curl https://localhost:8443/product-composite/999 -k -H "Authorization: Bearer $ACCESS_TOKEN" -X DELETE -i

http://my.redirect.uri/?code=OMS69I&state=72489
CODE=OMS69I

curl -k https://writer:secret@localhost:8443/oauth/token \
-d grant_type=authorization_code \
-d client_id=writer \
-d redirect_uri=http://my.redirect.uri \
-d code=$CODE -s | jq .

[writer]
ACCESS_TOKEN=eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJtYWdudXMiLCJleHAiOjIxNzcyOTQzNTcsImF1dGhvcml0aWVzIjpbIlJPTEVfVVNFUiJdLCJqdGkiOiJlMDNhZDRmMS04YjM5LTQ0ZWQtODIxMC0xZTg0MjdjMjE0NTUiLCJjbGllbnRfaWQiOiJ3cml0ZXIiLCJzY29wZSI6WyJwcm9kdWN0OnJlYWQiLCJwcm9kdWN0OndyaXRlIl19.AhHLhRG8xWUUB8NYB4Kuv8AcgEj-rqLPnTMsdMeQRudelkQn9Wd-mOVdz9zrRGfMEf9xS97aw6Tnwq0BHnKeQ-8jCfj4FJaynPsJnkarHm_mQRnPAO3f9pN6p4IMFbZ9xEE4ToW-qDTXXduYldANz7bEvYwccnGrkRP1eJTT0O9HE2HHlAd26IrwpBWLGlDeuooNouHJ-irKotQ_1qcnv5PL0-XqGwGMLiTaiASe6vRR7qk2afSt5sVuMa8Tz0nuxE_4BYtvfhlbh_-lx6ZDjwbTjyEEk3B-CczRw-nPEG4ugjkJsNoUQ-MpCxvrqvfXJej6vr8ifYH2eK_qoo3H5Q
curl https://localhost:8443/product-composite/999 -k -H "Authorization: Bearer $ACCESS_TOKEN" -X DELETE -i

docker-compose logs -f product-composite

docker-compose down